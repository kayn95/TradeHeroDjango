<!-- trades/templates/registration/register.html -->
{% extends 'trades/base.html' %}
{% load static %}

{% block title %}Inscription{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
  <div class="col-md-7 col-lg-5">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4 p-md-5">

        <h1 class="h3 mb-3 text-center">Cr√©er un compte</h1>

        {# Messages (success, error, info, warning) #}
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-3" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}

        {# Erreurs globales du formulaire #}
        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for err in form.non_field_errors %}{{ err }}{% endfor %}
          </div>
        {% endif %}

        <form method="post" novalidate>
          {% csrf_token %}

          {# Conserver la redirection si fournie #}
          {% if request.GET.next %}
            <input type="hidden" name="next" value="{{ request.GET.next }}">
          {% endif %}

          <div class="mb-3">
            <label for="{{ form.username.id_for_label }}" class="form-label">Nom d'utilisateur</label>
            {{ form.username.as_widget|safe }}
            {% if form.username.help_text %}
              <div class="form-text">{{ form.username.help_text|safe }}</div>
            {% endif %}
            {% if form.username.errors %}
              <div class="text-danger small">
                {% for e in form.username.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
            {{ form.email.as_widget|safe }}
            {% if form.email.help_text %}
              <div class="form-text">{{ form.email.help_text }}</div>
            {% endif %}
            {% if form.email.errors %}
              <div class="text-danger small">
                {% for e in form.email.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.password1.id_for_label }}" class="form-label">Mot de passe</label>
            <div class="input-group">
              {{ form.password1.as_widget|safe }}
              <button class="btn btn-outline-secondary" type="button" id="togglePwd1" aria-label="Afficher/masquer">
                üëÅÔ∏è
              </button>
            </div>
            {% if form.password1.help_text %}
              <div class="form-text">{{ form.password1.help_text|safe }}</div>
            {% endif %}
            <div id="pwdStrength" class="form-text"></div>
            {% if form.password1.errors %}
              <div class="text-danger small">
                {% for e in form.password1.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.password2.id_for_label }}" class="form-label">Confirmez le mot de passe</label>
            <div class="input-group">
              {{ form.password2.as_widget|safe }}
              <button class="btn btn-outline-secondary" type="button" id="togglePwd2" aria-label="Afficher/masquer">
                üëÅÔ∏è
              </button>
            </div>
            {% if form.password2.help_text %}
              <div class="form-text">{{ form.password2.help_text }}</div>
            {% endif %}
            {% if form.password2.errors %}
              <div class="text-danger small">
                {% for e in form.password2.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="id_terms" required>
            <label class="form-check-label" for="id_terms">
              J'accepte les conditions d'utilisation et la politique de confidentialit√©
            </label>
          </div>

          <div class="d-grid">
            <button id="submitBtn" type="submit" class="btn btn-primary">
              S'inscrire
            </button>
          </div>
        </form>

        <hr class="my-4">

        <p class="mb-0 text-center text-muted">
          Vous avez d√©j√† un compte ?
          <a href="{% url 'login' %}" class="link-primary text-decoration-none">Connectez-vous</a>
        </p>

      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    // Am√©liorer l'autocompl√©tion si les widgets n'ont pas d√©j√† ces attributs
    try {
      const u = document.getElementById('{{ form.username.id_for_label }}');
      if (u && !u.getAttribute('autocomplete')) u.setAttribute('autocomplete','username');
      const e = document.getElementById('{{ form.email.id_for_label }}');
      if (e && !e.getAttribute('autocomplete')) e.setAttribute('autocomplete','email');
      const p1 = document.getElementById('{{ form.password1.id_for_label }}');
      if (p1 && !p1.getAttribute('autocomplete')) p1.setAttribute('autocomplete','new-password');
      const p2 = document.getElementById('{{ form.password2.id_for_label }}');
      if (p2 && !p2.getAttribute('autocomplete')) p2.setAttribute('autocomplete','new-password');
      if (u) u.focus();
    } catch (_) {}

    // Toggle visibilit√© des mots de passe
    function toggle(btnId, inputId){
      const btn = document.getElementById(btnId);
      const inp = document.getElementById(inputId);
      if (!btn || !inp) return;
      btn.addEventListener('click', () => {
        const isPwd = inp.type === 'password';
        inp.type = isPwd ? 'text' : 'password';
        btn.setAttribute('aria-pressed', String(isPwd));
      });
    }
    toggle('togglePwd1', '{{ form.password1.id_for_label }}');
    toggle('togglePwd2', '{{ form.password2.id_for_label }}');

    // Indicateur de "force" tr√®s simple (client-side hint)
    const pwd = document.getElementById('{{ form.password1.id_for_label }}');
    const strength = document.getElementById('pwdStrength');
    if (pwd && strength) {
      pwd.addEventListener('input', () => {
        const v = pwd.value || '';
        let score = 0;
        if (v.length >= 8) score++;
        if (/[A-Z]/.test(v)) score++;
        if (/[a-z]/.test(v)) score++;
        if (/\d/.test(v)) score++;
        if (/[^A-Za-z0-9]/.test(v)) score++;
        const labels = ['Tr√®s faible', 'Faible', 'Moyen', 'Bon', 'Fort'];
        strength.textContent = v ? ('S√©curit√© du mot de passe : ' + labels[Math.min(score-1,4)]) : '';
      });
    }

    // Emp√™cher le double-submit
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    if (form && submitBtn) {
      form.addEventListener('submit', function(){
        submitBtn.disabled = true;
      });
    }
  })();
</script>
{% endblock %}
