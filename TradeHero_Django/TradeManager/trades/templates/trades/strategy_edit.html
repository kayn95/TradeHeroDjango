<!-- trades/templates/trades/strategy_edit.html -->

{% extends 'trades/base.html' %}

{% block title %}
    {% if strategy %}
        Modifier la Stratégie
    {% else %}
        Nouvelle Stratégie
    {% endif %}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">
        {% if strategy %}
            <i class="fas fa-edit"></i> Modifier la Stratégie
        {% else %}
            <i class="fas fa-plus"></i> Nouvelle Stratégie
        {% endif %}
    </h2>

    <!-- Affichage des messages d'erreur -->
    {% if form.errors or formset.errors %}
        <div class="alert alert-danger">
            <strong>Veuillez corriger les erreurs ci-dessous :</strong>
            <ul class="mb-0">
                {% for field, errors in form.errors.items %}
                    <li><strong>{{ field|capfirst }} :</strong> {{ errors|join:", " }}</li>
                {% endfor %}
                {% for form in formset.forms %}
                    {% for error in form.errors.values %}
                        <li>{{ error|join:", " }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Champs du formulaire principal (StrategyForm) -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                Informations de la Stratégie
            </div>
            <div class="card-body">
                <div class="form-group">
                    {{ form.name.label_tag }}
                    {{ form.name }}
                    {% for error in form.name.errors %}
                        <small class="form-text text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                    {% for error in form.description.errors %}
                        <small class="form-text text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Formset pour les captures d'écran -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                Captures d'écran
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                <div id="formset">
                    {% for form in formset %}
                        {{ form.id }} <!-- Assurez-vous que le champ 'id' est rendu avec sa valeur -->
                        <div class="form-row align-items-center mb-3">
                            <div class="col-md-8">
                                {{ form.image.label_tag }}
                                {{ form.image }}
                                {% for error in form.image.errors %}
                                    <small class="form-text text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                            <div class="col-md-4 text-center">
                                {% if form.instance.pk %}
                                    <div class="form-check mt-4">
                                        {{ form.DELETE }}
                                        {{ form.DELETE.label_tag }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <hr>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary" id="add-more">
                    <i class="fas fa-plus"></i> Ajouter un Screenshot
                </button>
            </div>
        </div>

        <!-- Boutons de soumission -->
        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Enregistrer
            </button>
            <a href="{% url 'strategy_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Annuler
            </a>
        </div>
    </form>

    <!-- Template pour un nouveau formulaire de screenshot -->
    <div id="empty-form" class="d-none">
        <div class="form-row align-items-center mb-3">
            <div class="col-md-8">
                {{ formset.empty_form.image.label_tag }}
                {{ formset.empty_form.image }}
                {% for error in formset.empty_form.image.errors %}
                    <small class="form-text text-danger">{{ error }}</small>
                {% endfor %}
            </div>
            <div class="col-md-4 text-center">
                <div class="form-check mt-4">
                    {{ formset.empty_form.DELETE }}
                    {{ formset.empty_form.DELETE.label_tag }}
                </div>
            </div>
        </div>
        <hr>
    </div>
</div>

<!-- Script pour ajouter dynamiquement des formulaires de screenshot -->
<script>
    document.getElementById('add-more').addEventListener('click', function(e) {
        e.preventDefault();
        var formsetDiv = document.getElementById('formset');
        var emptyFormDiv = document.getElementById('empty-form').innerHTML;
        var formIdx = parseInt(document.getElementById('id_screenshots-TOTAL_FORMS').value);

        // Remplacer __prefix__ par formIdx
        var newForm = emptyFormDiv.replace(/__prefix__/g, formIdx);

        // Ajouter le nouveau formulaire
        formsetDiv.insertAdjacentHTML('beforeend', newForm);

        // Incrémenter le TOTAL_FORMS
        document.getElementById('id_screenshots-TOTAL_FORMS').value = formIdx + 1;
    });
</script>
{% endblock %}
