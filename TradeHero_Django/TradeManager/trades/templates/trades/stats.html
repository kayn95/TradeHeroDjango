{% extends 'trades/base.html' %}

{% block title %}Statistiques{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Statistiques</h2>

  <!-- Formulaire pour choisir la stratégie -->
  <form method="get" class="form-inline mb-4">
    <label for="strategy_id" class="mr-2">Choisir une stratégie :</label>
    <select name="strategy_id" id="strategy_id" class="form-control mr-2">
      <option value="">-- Sélectionnez --</option>
      {% for strat in strategies %}
        <option value="{{ strat.id }}"
          {% if selected_strategy and strat.id == selected_strategy.id %}
            selected
          {% endif %}
        >
          {{ strat.name }}
        </option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary">Voir les stats</button>
  </form>

  {% if selected_strategy %}
    <hr>
    <h4>Stratégie : {{ selected_strategy.name }}</h4>
    <p><strong>Description :</strong><br>{{ selected_strategy.description|linebreaks }}</p>

    <p>Profit total : <strong>{{ total_profit }}</strong></p>
    <p>Nombre de trades : <strong>{{ nb_trades }}</strong></p>
    <p>Taux de réussite : <strong>{{ win_rate|floatformat:"2" }} %</strong></p>

    <div class="mt-4">
      <!-- Conteneur du graphique -->
      <canvas id="myChart" width="800" height="400"></canvas>
    </div>
  {% else %}
    <p class="mt-3 text-muted">Sélectionnez une stratégie pour voir les statistiques.</p>
  {% endif %}
</div>
{% endblock %}


{% block extra_js %}
{% if chart_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Récupération des données JSON passées depuis la vue
  const data = JSON.parse('{{ chart_data|safe }}');

  // data.x => Les dates
  // data.y => Le profit cumulatif à chaque trade
  const ctx = document.getElementById('myChart').getContext('2d');
  const myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.x,
      datasets: [{
        label: 'Profit Cumulatif',
        data: data.y,
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
</script>
{% endif %}
{% endblock %}
