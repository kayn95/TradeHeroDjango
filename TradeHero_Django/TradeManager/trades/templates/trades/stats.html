{% extends 'trades/base.html' %}
{% load humanize %}

{% block title %}Statistiques{% endblock %}

{% block content %}
<div class="container mt-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Accueil</a></li>
      <li class="breadcrumb-item active" aria-current="page">Statistiques</li>
    </ol>
  </nav>

  <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
    <div>
      <h2 class="mb-1">Statistiques</h2>
      {% if viewing_student %}
        <div class="alert alert-secondary py-2 mb-0 mt-2">
          Vous consultez les statistiques de <strong>{{ viewing_student.username }}</strong>.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Sélecteur de stratégie (et conservation de student_id) -->
  <form method="get" class="row g-2 align-items-end mb-4">
    {% if viewing_student %}
      <input type="hidden" name="student_id" value="{{ viewing_student.id }}">
    {% endif %}
    <div class="col-12 col-md-6 col-lg-4">
      <label for="strategy_id" class="form-label">Choisir une stratégie</label>
      <select name="strategy_id" id="strategy_id" class="form-select">
        <option value="">— Sélectionnez —</option>
        {% for strat in strategies %}
          <option value="{{ strat.id }}" {% if selected_strategy and strat.id == selected_strategy.id %}selected{% endif %}>
            {{ strat.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-auto">
      <button type="submit" class="btn btn-primary mt-3 mt-md-0">Voir les stats</button>
    </div>
  </form>

  {% if selected_strategy %}
    <!-- Bloc infos stratégie (NOUVEAU: description + screenshots) -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>{{ selected_strategy.name }}</strong>
        <a href="{% url 'strategy_detail' selected_strategy.id %}" class="btn btn-sm btn-outline-secondary">Détails</a>
      </div>
      <div class="card-body">
        {% if selected_strategy.description %}
          <div class="mb-3">
            <div class="text-muted small mb-1">Description</div>
            <div class="border rounded p-2">{{ selected_strategy.description|linebreaks }}</div>
          </div>
        {% endif %}

        <div class="mb-2 text-muted small">Captures d’écran</div>
        {% with sc=selected_strategy.screenshots.all %}
          {% if sc|length %}
            <div class="row g-2">
              {% for screenshot in sc|slice:":9" %}
                <div class="col-6 col-md-4 col-lg-3">
                  <img src="{{ screenshot.image.url }}" class="img-fluid rounded border" alt="Screenshot {{ forloop.counter }}">
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">Aucune capture d’écran disponible pour cette stratégie.</div>
          {% endif %}
        {% endwith %}
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">Profit total</div>
          <div class="fs-5 fw-semibold {% if total_profit > 0 %}text-success{% elif total_profit < 0 %}text-danger{% endif %}">
            {{ total_profit|floatformat:2|intcomma }} €
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">Nb. de trades</div>
          <div class="fs-5 fw-semibold">{{ nb_trades }}</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">Taux de réussite</div>
          <div class="fs-5 fw-semibold">{{ win_rate|floatformat:2 }} %</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">Profit moyen / trade</div>
          <div class="fs-5 fw-semibold">{{ average_profit|floatformat:2|intcomma }} €</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">Gain moyen (%)</div>
          <div class="fs-5 fw-semibold">{{ average_gain_percent|floatformat:2 }} %</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">Capital investi</div>
          <div class="fs-5 fw-semibold">{{ total_investment|floatformat:2|intcomma }} €</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="p-3 border rounded h-100">
          <div class="text-muted small">ROI</div>
          <div class="fs-5 fw-semibold">{{ roi|floatformat:2 }} %</div>
        </div>
      </div>
    </div>

    <!-- Graphique PnL cumulatif -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header">Évolution du profit cumulatif</div>
      <div class="card-body">
        {% if chart_data %}
          <canvas id="equityChart" height="96"></canvas>
        {% else %}
          <div class="text-muted">Pas de données suffisantes pour tracer la courbe.</div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      Sélectionnez une stratégie pour voir les statistiques.
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-submit au changement de stratégie (UX)
  (function(){
    const sel = document.getElementById('strategy_id');
    if (sel) sel.addEventListener('change', () => sel.form.submit());
  })();
</script>

{% if chart_data %}
  <!-- Sans SRI pour éviter le blocage "integrity" -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    (function(){
      const raw = '{{ chart_data|escapejs }}';
      let data = null;
      try { data = JSON.parse(raw); } catch(e) {}
      if (!data) return;

      const ctx = document.getElementById('equityChart');
      if (!ctx) return;

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.x,
          datasets: [{
            label: 'Profit cumulatif (€)',
            data: data.y,
            tension: 0.25,
            pointRadius: 0,
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { ticks: { maxTicksLimit: 8 } },
            y: {
              beginAtZero: false,
              ticks: { callback: (v) => `${v} €` }
            }
          },
          plugins: { legend: { display: true } }
        }
      });
    })();
  </script>
{% endif %}
{% endblock %}
